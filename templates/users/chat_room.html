<!DOCTYPE html>
<html>
<head>
    <title>Chat with {{ other_user.username }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; font-size: 0.95rem; }
        .sent { align-self: flex-end; background-color: #0084ff; color: white; border-bottom-right-radius: 5px; }
        .received { align-self: flex-start; background-color: #e4e6eb; color: black; border-bottom-left-radius: 5px; }
        .input-area { background: white; padding: 15px; border-top: 1px solid #ddd; }
    </style>
</head>
<body>
    
    <div class="bg-white shadow-sm p-3 d-flex align-items-center">
        <a href="{% url 'home' %}" class="text-decoration-none me-3">⬅ Back</a>
        <img src="{{ other_user.profile.image.url }}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
        <h5 class="m-0 fw-bold">{{ other_user.username }}</h5>
    </div>

    <div class="chat-container" id="chat-box">
        {% for msg in chat_messages %}
            <div class="message {% if msg.sender == user %}sent{% else %}received{% endif %}">
                {{ msg.content }}
            </div>
        {% endfor %}
    </div>

    <div class="input-area">
        <div class="input-group">
            <input type="text" id="message-input" class="form-control rounded-pill" placeholder="Type a message...">
            <button id="send-btn" class="btn btn-primary rounded-pill ms-2 px-4">Send</button>
        </div>
    </div>

    <script>
        const roomName = "{{ other_user.username }}";
        const currentUser = "{{ user.username }}";
        
        // -------------------------------------------------------
        // ✅ FIX: Determine correct protocol (wss:// for Cloud)
        // -------------------------------------------------------
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const socket = new WebSocket(protocol + window.location.host + '/ws/chat/' + roomName + '/');

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const chatBox = document.getElementById('chat-box');
            
            // Create Message Bubble
            const div = document.createElement('div');
            div.classList.add('message');
            
            // Check if 'sender' exists in the data, or infer it
            // (Adjust logic based on what your consumer sends back)
            if (data.username === currentUser || data.sender === currentUser) {
                div.classList.add('sent');
            } else {
                div.classList.add('received');
            }
            div.innerText = data.message;
            
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight; // Auto scroll to bottom
        };

        socket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        // Send Message
        document.getElementById('send-btn').onclick = function() {
            const input = document.getElementById('message-input');
            const message = input.value;
            if (message) {
                // Send standard format to backend
                socket.send(JSON.stringify({ 
                    'message': message, 
                    'username': currentUser 
                }));
                input.value = '';
            }
        };

        // Allow "Enter" key to send
        document.getElementById('message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter key
                document.getElementById('send-btn').click();
            }
        };
    </script>
</body>
</html>